# Conception des données

Nous allons concevoir notre schéma de données pour créer plus facilement nos entités et nos relations sous Symfony.

ATTENTION : notre MCD doit donc appliquer une nomenclature PHP et non SQL pour le nommage des tables et des champs.

**Exemple :**
Table `article` avec le champ `id`, `title`

**En SQL on aurait utilisé par exemple :**
Table `blog_article` avec le champ `art_id`, `art_title`

## Etape 1 : modélisation de la base de données

Nous allons modéliser la base de données sous MysqlWorkBench avec les informations suivantes sur les tables.
Pour la modélisation il faut installer MysqlWorkBench. 
Puis dans le menu `File > New Model` ou `Fichier > Nouveau Model`
Ensuite vous devez renomer votre base de données de MyDb vers Blog puis créer un diagramme :

![Image](./imgMarkDown/MySQLWorkbench1.png)

Dans le diagramme vous devez ajouter une première table, puis la renommer (par exemple **article**) :

![Image](./imgMarkDown/MySQLWorkbench2.png)

![Image](./imgMarkDown/MySQLWorkbench3.png)

Il faut ensuite ajouter nos noms de colonnes et leur propriétés :

![Image](./imgMarkDown/MySQLWorkbench4.png)

>
> Ajouter tous les champs (colonnes) à la table **article** puis faîtes toutes vos tables. 
>
> Reportez vous pour ça aux définitions de nos table ci-après.
>
> Nous passerons ensuite aux relations et à la cardinalité des ces relations entre nos table !
>

** A savoir : **

> **PK** : primaryKey
>
> **NN** : not null
>
> **UQ** : unique key (pour l'email de l'utilisateur par exemple, pas de doublon dans la base)
>
> **B**  : binarie : données binaire (Inutile pour nous !)
>
> **UN** : unsigned : des chiffres positifs seulement 
>
> **ZF** : zero forced : si numéric  rajoute des 0 devant le nombre pour stocker un nombre de caractère donné. Exemple si INT(11) et 50000 dedans, Mysql stockera en réalité 00000050000 dans la table)
>
> **AI** : auto increment : pour les clefs primaires, obligatoire pour nous
>
> **G** : générated column : colonne générée à partir d'autres colonnes (inutile pour nous)

Vous pouvez sélectionner le type de colonne (INT, VARCHAR, TEXT, DATETIME) et donnez des paramètre (INT(11) un entier sur 4 octets avec 11 chiffres maximum, ou VARCHAR(255) une chaine de 255 caractères maximum)

Pour comprendre la différences entre BYTES, bit, Octet :

[Infos BYTES, bit, octet](https://www.science.lu/fr/les-unites-informatiques/quest-ce-que-les-bit-byte-octet)

Pour comprendre les types de champs possible dans MySql et leur taille :

[Tuto SQL TYPE](https://openclassrooms.com/fr/courses/1959476-administrez-vos-bases-de-donnees-avec-mysql/1960456-distinguez-les-differents-types-de-donnees)


### Table article
    - id (PrimaryKey)
    - title 
    - content 
    - picture 
    - createdAt 
    - publishedAt 
    - valid

### Table category

à définir ensemble

### Table comment

à définir ensemble

### Table user

à définir ensemble


## Nous devons maintenant ajouter les relations

Pour le moment dans les colonnes proposées ci-dessus nous n'avons pas les clefs étrangères. 

Le fait de faire ces relations va créer ces clefs automatiquement.

Par exemple dans la table `article` nous auront 2 colonnes de plus pour la clef étrangère de la catégorie et celle de l'utilisateur (auteur de l'article). 

**Les relations sont les suivantes :** 

A l'aide de ces données vous devez déterminer vos relations

> 1 utilisateur peut créer articles
>
> 1 catégorie peut contenir plusieurs articles
>
> 1 article peut avoir plusieurs commentaires
>
> 1 catégorie peut appartenir à une autre catégorie

**Pour créer nos relations**

![Image](./imgMarkDown/MySQLWorkbench5.png)

On sélectionne dans le menu la relation souhaitée (on utilise uniquement les relations non identifiées représentées avec des pointilés).

Cliquez ensuite sur le table de droite (n) puis sur la table de gauche (1) pour une cardinalité de 1 à n !

**C'est parti notre MCD modélisée, nous allons pouvoir passer à nos entités Symfony**


## Etape 2 : création des entités et des relations sous Symfony

ATTENTION pour le moment on ne va pas créer l'entité `User` !

Nous allons créer nos entité Article, Category et Comment.
Pour le moment pas de relation nous éditerons nos entités ensuite pour rajouter les relations.
Il n'est pas nécessaire de créer la propriété **id** de nos entité, Symfony s'en occupe ! 

> https://symfony.com/doc/current/doctrine.html
> https://symfony.com/doc/current/doctrine.html#creating-an-entity-class

### Les lignes de commandes utiles pour les entités

```bash
# creer une entité
php bin/console make:entity

# éditer une entité pour ajouter des propriétés. Ici l'entité Article
php bin/console make:entity Article

# Créer une migration (quand on a terminé les entités et leurs relations)
php bin/console make:migration

# Attention ne pas créer plusieurs migration avant de migrer ;) ça évite les problèmes !
# Si vous avez fait des erreurs après migration, modifiez vos entités, créez la migration et migrez 

# Executé la migration pour créer nos table dans la base de données
php bin/console doctrine:migrations:migrate
```

### Hydrater notre base de donnée : les fixtures.

> https://symfony.com/doc/current/bundles/DoctrineFixturesBundle/index.html

```bash
# installer le package
composer require --dev orm-fixtures

# Executer les fixtures (faut faire la fixture avant.. voir ci-après)
php bin/console Doctrine:fixtures:load
```

Vous pouvez ensuite ouvrir le fichier `src/fixtures/AppFixtures.php`

La méthode Load sera executé quand on appelle l'exécution des fixtures en ligne de commandes. 

On va y mettre le code qui va générer du contenu dans notre base de données... en utilisant le **Manager** qui est injecté dans la méthode `load()`

** Exemple à adapter à vos besoins (non de vos propriétés...), et rajoutez 10 commentaires par Article ;)

```php
 public function load(ObjectManager $manager)
    {
        $faker = Factory::create('fr_FR');
        
        for ($j=0;$j<10;$j++) {
            $category = new Category();
            $category->setTitle($faker->sentence())
                ->setDescription($faker->realText(300))
                ->setPicture('https://picsum.photos/300/200?id='.uniqid());

            $manager->persist($category);

            for ($i=0;$i<10;$i++) {
                $article = new Article();
                $article->setTitle($faker->sentence())
                ->setContent($faker->realText(600))
                ->setCreatedAt(new \DateTime($faker->date('Y-m-d H:i')))
                ->setPublishedAt(new \DateTime($faker->date('Y-m-d H:i')))
                ->setPicture('https://picsum.photos/300/200?id='.uniqid())
                ->setCategory($category)
                ->setValid(true);

                $manager->persist($article);
            }
        }
        $manager->flush();
    }
```




